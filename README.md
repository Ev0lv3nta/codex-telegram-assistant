# Personal Assistant (Codex CLI + Telegram)

Этот репозиторий содержит Telegram-бота на `aiogram`, который проксирует сообщения в Codex CLI и
поддерживает "долгую" сессию (контекст) на чат.

## Структура

- `system/bot/` код Telegram-шлюза и воркера
- `daily/` ежедневные заметки (формат Obsidian)
- `topics/` тематические заметки
- `system/tasks/bot_state.db` SQLite для очереди и привязки `chat_id -> session_id`
- `~/.codex/sessions/` локальные сохраненные сессии Codex CLI (rollout-*.jsonl)

Вложения из Telegram сохраняются на диск по мере прихода (папки создаются при необходимости):
- `88_files/` документы/аудио/видео
- `89_images/` изображения

## Команды бота

- `/start` краткая справка
- `/status` состояние очереди + текущий session id
- `/reset` сбросить сессию чата (новый контекст)
- `/gc [days]` почистить старые сохраненные сессии Codex CLI на диске (по умолчанию 7 дней)

## Как это работает (коротко)

1. Бот получает сообщение и (если есть) скачивает вложения.
2. Ставит задачу в очередь SQLite.
3. Worker вызывает `codex exec` для новой сессии или `codex exec resume <session_id>` для продолжения.
4. Ответ отправляется обратно в Telegram.
5. Если в ответе модели есть строки вида `[[send-file:relative/path]]`, бот отправит указанные файлы как документы.

## Настройка

Минимум в `system/bot/.env`:
- `TG_BOT_TOKEN=...`
- `TG_ALLOWED_USER_IDS=...`

Модель/effort задаются через `CODEX_MODEL` и `CODEX_EXTRA_ARGS`.

### Voice -> Text (OpenRouter STT)

Бот поддерживает транскрибацию голосовых сообщений через OpenRouter (модель по умолчанию:
`mistralai/voxtral-small-24b-2507`).

Нужные переменные:
- `OPENROUTER_API_KEY`
- `OPENROUTER_BASE_URL` (по умолчанию `https://openrouter.ai/api/v1`)
- `OPENROUTER_STT_MODEL`
- `OPENROUTER_STT_TIMEOUT_SEC`
- `OPENROUTER_STT_MAX_AUDIO_BYTES`

Поведение:
- Если приходит голосовое без текста, бот пытается распознать речь и подставляет результат как обычный текст запроса.
- Если STT не сработал, бот отправляет пользователю сообщение об ошибке вида
  `Голосовое не обработано: ...` и продолжает работать для остальных сообщений.
